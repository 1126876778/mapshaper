/* @requires loading.jsonp, core, browser */



// Example: http://dev.virtualearth.net/REST/v1/Locations?key=Auqe0GvU3HGosPdUjohzTndfCa1_PuKNJMcyvVGL1jEoPhuj4lmAQyMl7cI-Ecev&query=San Francisco&jsonp=nytg.get_data
var Bing = {
  NYT_KEY: "Auqe0GvU3HGosPdUjohzTndfCa1_PuKNJMcyvVGL1jEoPhuj4lmAQyMl7cI-Ecev",
  SERVICE_URL: "http://dev.virtualearth.net/REST/v1/Locations"
};


/**
 *  Usage: Bing.geocodeAddress("Some address", function(data) { console.log(data); }, {excludeDC: true});
 */
Bing.geocodeAddress = function(rawQuery, callback, opts) {
  var defaults = {
    onlyUSA: true,
    excludeDC: false
  };
  opts = Opts.copyAllParams(defaults, opts);

  var jsonpCallback = Utils.getUniqueName();
  var url = Browser.extendUrl(Bing.SERVICE_URL, {
    key: opts.key || Bing.NYT_KEY,
    query: rawQuery,
    jsonp: jsonpCallback
  });

  JsonPLoader.load(url, jsonpCallback, function(raw) {
    var retn;
    try {
      var r0 = raw.resourceSets[0].resources[0];
      var addr = r0.address;

      if (opts.onlyUSA && addr.countryRegion != "United States") {
        throw new Error("Address not in U.S.");
      }

      if (opts.excludeDC && addr.adminDistrict == 'DC') {
        throw new Error("Washington D.C. addresses are excluded.");
      }

      retn = {
        lat: r0.point.coordinates[0],
        lng: r0.point.coordinates[1],
        formattedAddress: addr.formattedAddress,  // e.g. "San Francisco, CA"
        countryRegion: addr.country,  // e.g. "United States"
        adminDistrict: addr.adminDistrict,  // e.g. "CA"
        queryString: rawQuery
      };
    }
    catch(err) {
      trace("Geocoder exception:", err);
      retn = null;
    }

    callback(retn);
  });

};